<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة بلاغات الحافلات - لوحة التحكم</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #1976d2;
            --primary-dark: #1565c0;
            --primary-light: #e3f2fd;
            --secondary: #ff9800;
            --success: #4caf50;
            --danger: #e53935;
            --warning: #ff9800;
            --info: #2196f3;
            --violation: #9c27b0;
            --dark: #333;
            --light: #f8f9fa;
            --gray: #6c757d;
            --border: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --radius: 8px;
            --transition: all 0.3s ease;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            line-height: 1.6;
            font-size: 16px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        /* Header Enhanced */
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 30px 25px;
            border-radius: var(--radius);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }
        header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: float 10s infinite ease-in-out;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }
        header p {
            opacity: 0.95;
            font-size: 1.1rem;
            position: relative;
            z-index: 1;
        }
        /* Summary Cards Enhanced */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .summary-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: var(--transition);
            border: 2px solid transparent;
        }
        .summary-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border-color: var(--primary-light);
        }
        .summary-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: var(--transition);
        }
        .summary-card:hover .summary-icon {
            transform: rotate(360deg);
        }
        .summary-content {
            flex: 1;
        }
        .summary-title {
            font-size: 0.95rem;
            color: var(--gray);
            margin-bottom: 5px;
            font-weight: 600;
        }
        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
        }
        .new .summary-icon { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .late .summary-icon { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
        .stopped .summary-icon { background: linear-gradient(135deg, #fa709a, #fee140); color: white; }
        .duplicate .summary-icon { background: linear-gradient(135deg, #30cfd0, #330867); color: white; }
        .total .summary-icon { background: linear-gradient(135deg, #a8edea, #fed6e3); color: white; }
        /* Controls Enhanced */
        .controls {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 14px 18px 14px 50px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
        }
        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }
        .search-box i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 1.2rem;
        }
        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        select {
            padding: 14px 18px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-family: 'Cairo', sans-serif;
            background: white;
            min-width: 150px;
            font-size: 1rem;
            transition: var(--transition);
            cursor: pointer;
        }
        select:hover {
            border-color: var(--primary-light);
        }
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            font-size: 1rem;
            font-weight: 600;
            min-height: 48px;
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(25, 118, 210, 0.3);
        }
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #f57c00);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #c62828);
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, var(--success), #388e3c);
            color: white;
        }
        .btn-info {
            background: linear-gradient(135deg, var(--info), #1976d2);
            color: white;
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }
        /* Table Enhanced */
        .table-container {
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
            font-size: 0.95rem;
        }
        th, td {
            padding: 15px 12px;
            border-bottom: 1px solid var(--border);
            text-align: right;
            vertical-align: middle;
        }
        tr {
            transition: var(--transition);
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        tr:nth-child(odd) {
            background: #ffffff;
        }
        th {
            background: linear-gradient(135deg, var(--primary-light), #bbdefb);
            color: var(--primary-dark);
            font-weight: 700;
            position: sticky;
            top: 0;
            font-size: 1rem;
            z-index: 10;
        }
        tr:hover {
            background: linear-gradient(90deg, #e3f2fd, #f5f5f5) !important;
            transform: scale(1.01);
        }
        /* Status & Priority Enhanced */
        .priority-high { 
            color: #d32f2f; 
            font-weight: bold; 
            text-shadow: 0 1px 2px rgba(211, 47, 47, 0.2);
        }
        .priority-medium { 
            color: #f57c00; 
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(245, 124, 0, 0.2);
        }
        .priority-normal { 
            color: #2e7d32; 
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(46, 125, 50, 0.2);
        }
        .priority-stop { 
            color: #7b1fa2; 
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(123, 31, 162, 0.2);
        }
        .priority-violation { 
            color: #9c27b0; 
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(156, 39, 176, 0.2);
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: var(--transition);
        }
        .status-badge:hover {
            transform: scale(1.05);
        }
        .status-new { background: linear-gradient(135deg, #e3f2fd, #bbdefb); color: #1565c0; }
        .status-received { background: linear-gradient(135deg, #e8f5e9, #c8e6c9); color: #2e7d32; }
        .status-repairing { background: linear-gradient(135deg, #fff3e0, #ffe0b2); color: #ef6c00; }
        .status-fixed { background: linear-gradient(135deg, #e8f5e9, #a5d6a7); color: #2e7d32; }
        .status-not-fixed { background: linear-gradient(135deg, #ffebee, #ffcdd2); color: #c62828; }
        .status-waiting { background: linear-gradient(135deg, #f3e5f5, #e1bee7); color: #7b1fa2; }
        .status-closed { background: linear-gradient(135deg, #f5f5f5, #e0e0e0); color: #616161; }
        /* Countdown Enhanced */
        .countdown {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .countdown.warning { 
            color: #ef6c00;
            animation: pulse 2s infinite;
        }
        .countdown.urgent { 
            color: #c62828;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .progress-bar {
            position: relative;
            height: 12px;
            background: linear-gradient(90deg, #e0e0e0, #f5f5f5);
            border-radius: 6px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            transition: width 0.5s ease-out;
            color: #fff;
            font-size: 10px;
            text-align: center;
            line-height: 12px;
            position: relative;
        }
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                rgba(255,255,255,0) 0%,
                rgba(255,255,255,0.3) 50%,
                rgba(255,255,255,0) 100%);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .progress-fill.green { background: linear-gradient(90deg, #4caf50, #81c784); }
        .progress-fill.orange { background: linear-gradient(90deg, #ff9800, #ffb74d); }
        .progress-fill.red { background: linear-gradient(90deg, #e53935, #ef5350); }
        .progress-fill.blink { 
            animation: soft-blink 1.4s ease-in-out infinite;
        }
        @keyframes soft-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: .7; }
        }
        /* Action Buttons Enhanced */
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
            justify-content: center;
        }
        .btn-action {
            width: 44px;
            height: 44px;
            padding: 0;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 1.1rem;
            min-width: 44px;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        .btn-action::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        .btn-action:hover::before {
            width: 100%;
            height: 100%;
        }
        .btn-action:hover {
            transform: translateY(-3px) rotate(5deg);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        .btn-view { 
            background: linear-gradient(135deg, var(--primary), #1e88e5); 
            color: white; 
        }
        .btn-wa { 
            background: linear-gradient(135deg, #25d366, #128c7e); 
            color: white; 
        }
        .btn-delete { 
            background: linear-gradient(135deg, var(--danger), #c62828); 
            color: white; 
        }
        /* Bus Number Link Enhanced */
        .bus-number-link {
            color: var(--primary);
            text-decoration: none;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            padding: 6px 10px;
            border-radius: 6px;
            display: inline-block;
            background: linear-gradient(135deg, transparent, transparent);
        }
        .bus-number-link:hover {
            background: linear-gradient(135deg, var(--primary-light), #e3f2fd);
            text-decoration: underline;
            transform: scale(1.05);
        }
        /* Loading Enhanced */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(103, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 25px;
        }
        .loading-overlay.active {
            display: flex;
        }
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text {
            font-size: 1.3rem;
            color: white;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Modals Enhanced */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.5), rgba(0,0,0,0.7));
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            z-index: 3000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { 
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .modal-wide {
            max-width: 800px;
        }
        .modal-large {
            max-width: 900px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            transition: var(--transition);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-btn:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        /* Password Modal */
        .password-modal {
            max-width: 400px;
        }
        .password-input-group {
            position: relative;
            margin: 20px 0;
        }
        .password-input-group input {
            width: 100%;
            padding: 14px 50px 14px 18px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 1.1rem;
            transition: var(--transition);
        }
        .password-input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
        }
        .password-toggle:hover {
            color: var(--primary);
        }
        .password-error {
            color: var(--danger);
            font-size: 0.9rem;
            margin-top: 8px;
            display: none;
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .password-error.show {
            display: block;
        }
        /* Form Enhanced */
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-family: 'Cairo', sans-serif;
            font-size: 1rem;
            transition: var(--transition);
        }
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        .form-row {
            display: flex;
            gap: 12px;
        }
        .form-row .form-group {
            flex: 1;
        }
        /* Toast Enhanced */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: var(--radius);
            color: #fff;
            font-weight: 600;
            opacity: 0;
            transition: .3s;
            z-index: 10000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 250px;
            animation: slideInRight 0.3s ease;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .toast.show { opacity: 1; }
        .toast.success { background: linear-gradient(135deg, var(--success), #66bb6a); }
        .toast.error { background: linear-gradient(135deg, var(--danger), #ef5350); }
        .toast.warning { background: linear-gradient(135deg, var(--warning), #ffa726); }
        .toast.info { background: linear-gradient(135deg, var(--info), #42a5f5); }
        .toast i {
            font-size: 1.3rem;
        }
        /* Detail Sections Enhanced */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .detail-section {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 22px;
            border-radius: var(--radius);
            border-right: 4px solid var(--primary);
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            transition: var(--transition);
        }
        .detail-section:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .detail-section h4 {
            color: var(--primary);
            margin-bottom: 18px;
            font-size: 1.15rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
            padding-bottom: 14px;
            border-bottom: 1px solid #dee2e6;
        }
        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .detail-label {
            font-weight: 600;
            color: var(--dark);
            min-width: 140px;
            font-size: 0.95rem;
        }
        .detail-value {
            color: var(--gray);
            text-align: left;
            flex: 1;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        /* SLA Settings Enhanced */
        .sla-level {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border-radius: var(--radius);
            padding: 22px;
            margin-bottom: 20px;
            border-left: 5px solid var(--primary);
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .sla-level:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .sla-level.high { border-left-color: #d32f2f; }
        .sla-level.medium { border-left-color: #f57c00; }
        .sla-level.normal { border-left-color: #2e7d32; }
        .sla-level.stop { border-left-color: #7b1fa2; }
        .sla-level.violation { border-left-color: #9c27b0; }
        .sla-title {
            font-weight: 700;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.15rem;
            color: var(--dark);
        }
        /* Auto Close Settings */
        .auto-close-section {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border-radius: var(--radius);
            padding: 22px;
            margin-bottom: 20px;
            border-left: 5px solid var(--warning);
            transition: var(--transition);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .auto-close-section:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .auto-close-title {
            font-weight: 700;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.15rem;
            color: var(--dark);
        }
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        .empty-state p {
            font-size: 1.2rem;
            font-weight: 500;
        }
        /* Security Badge */
        .security-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1;
        }
        .security-badge i {
            color: #ffd700;
        }
        /* Additional Styles */
        .tr-urgent {
            background: linear-gradient(90deg, #ffebee, #ffcdd2) !important;
            animation: pulse-row 2s infinite;
        }
        .tr-warning {
            background: linear-gradient(90deg, #fff3e0, #ffe0b2) !important;
        }
        .tr-final {
            background: linear-gradient(90deg, #e8f5e9, #c8e6c9) !important;
        }
        .archived-row {
            opacity: 0.7;
            background: linear-gradient(90deg, #f5f5f5, #e0e0e0) !important;
        }
        .archived-badge {
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        @keyframes pulse-row {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .notes-field {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .notes-field.active {
            opacity: 1;
        }
        /* Responsive Enhanced */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            header h1 {
                font-size: 1.5rem;
            }
            .summary-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            .detail-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                padding: 20px;
            }
            .action-buttons {
                gap: 5px;
            }
            .btn-action {
                width: 38px;
                height: 38px;
                font-size: 0.95rem;
            }
        }
        @media (max-width: 480px) {
            .form-row {
                flex-direction: column;
            }
            .controls {
                padding: 15px;
            }
            .btn {
                padding: 12px 20px;
                font-size: 0.95rem;
            }
            table {
                font-size: 0.85rem;
            }
            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة التحميل -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">جاري تحميل البيانات...</div>
    </div>
    <div class="container">
        <header>
            <div class="security-badge">
                <i class="fas fa-shield-alt"></i>
                نظام محمي
            </div>
            <h1><i class="fas fa-bus"></i> لوحة إدارة بلاغات الحافلات</h1>
            <p>نظام متابعة البلاغات الذكي - إدارة، تنبيهات، واتساب</p>
        </header>
        <div class="summary-grid">
            <div class="summary-card new">
                <div class="summary-icon">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-title">البلاغات الجديدة</div>
                    <div class="summary-value" id="newCount">0</div>
                </div>
            </div>
            <div class="summary-card late">
                <div class="summary-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-title">المتأخرة</div>
                    <div class="summary-value" id="lateCount">0</div>
                </div>
            </div>
            <div class="summary-card stopped">
                <div class="summary-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-title">المتوقفة</div>
                    <div class="summary-value" id="stoppedCount">0</div>
                </div>
            </div>
            <div class="summary-card duplicate">
                <div class="summary-icon">
                    <i class="fas fa-copy"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-title">المكررة</div>
                    <div class="summary-value" id="duplicateCount">0</div>
                </div>
            </div>
            <div class="summary-card total">
                <div class="summary-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="summary-content">
                    <div class="summary-title">الإجمالي</div>
                    <div class="summary-value" id="totalCount">0</div>
                </div>
            </div>
        </div>
        <div class="controls">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" placeholder="ابحث في البلاغات...">
            </div>
            <div class="filter-group">
                <select id="statusFilter">
                    <option value="">جميع الحالات</option>
                    <option value="بلاغ جديد">بلاغ جديد</option>
                    <option value="تم الاستلام">تم الاستلام</option>
                    <option value="جاري الإصلاح">جاري الإصلاح</option>
                    <option value="تم الإصلاح">تم الإصلاح</option>
                    <option value="لم يتم الإصلاح">لم يتم الإصلاح</option>
                    <option value="مغلق">مغلق</option>
                    <option value="انتظار توفر قطع غيار">انتظار توفر قطع غيار</option>
                    <option value="عدم توفر قطع غيار">عدم توفر قطع غيار</option>
                    <option value="انتظار الموافقة">انتظار الموافقة</option>
                    <option value="متأخر">متأخر</option>
                </select>
                <select id="priorityFilter">
                    <option value="">جميع المستويات</option>
                    <option value="عالي">عالي</option>
                    <option value="متوسط">متوسط</option>
                    <option value="عادي">عادي</option>
                    <option value="مسار متوقف">مسار متوقف</option>
                    <option value="مخالفة تطوير">مخالفة تطوير</option>
                </select>
                <button class="btn btn-primary" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> تحديث
                </button>
                <button class="btn btn-info" id="exportBtn">
                    <i class="fas fa-file-excel"></i> تصدير
                </button>
                <button class="btn btn-success" id="viewReportBtn">
                    <i class="fas fa-file-alt"></i> عرض التقرير
                </button>
                <button class="btn btn-warning" id="slaSettingsBtn">
                    <i class="fas fa-cog"></i> إعدادات SLA
                </button>
                <button class="btn btn-secondary" id="autoCloseSettingsBtn">
                    <i class="fas fa-clock"></i> وقت الإغلاق
                </button>
            </div>
        </div>
        <div class="table-container">
            <table id="reportsTable">
                <thead>
                    <tr>
                        <th>رقم البلاغ</th>
                        <th>التاريخ</th>
                        <th>رقم الحافلة</th>
                        <th>نوع العطل</th>
                        <th>الوصف</th>
                        <th>الأهمية</th>
                        <th>الحالة</th>
                        <th>الوقت المتبقي</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody">
                    <!-- البيانات سيتم تحميلها هنا -->
                </tbody>
            </table>
        </div>
    </div>
    <!-- Modal للتحقق من كلمة المرور -->
    <div class="modal" id="passwordModal">
        <div class="modal-content password-modal">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-lock"></i> التحقق من الصلاحيات</h3>
                <button class="close-btn" onclick="closeModal('passwordModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="text-align: center; margin-bottom: 20px; color: var(--gray);">
                    يرجى إدخال كلمة المرور للوصول إلى هذه الوظيفة
                </p>
                <div class="password-input-group">
                    <input type="password" id="passwordInput" class="form-control" 
                           placeholder="أدخل كلمة المرور" autocomplete="off">
                    <button class="password-toggle" onclick="togglePassword()">
                        <i class="fas fa-eye" id="passwordToggleIcon"></i>
                    </button>
                </div>
                <div class="password-error" id="passwordError">
                    <i class="fas fa-exclamation-circle"></i> كلمة المرور غير صحيحة
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="passwordSubmitBtn">
                    <i class="fas fa-check"></i> تأكيد
                </button>
                <button class="btn btn-danger" onclick="closeModal('passwordModal')">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    </div>
    <!-- Modal لعرض تفاصيل البلاغ -->
    <div class="modal" id="viewModal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-info-circle"></i> تفاصيل البلاغ</h3>
                <button class="close-btn" onclick="closeModal('viewModal')">&times;</button>
            </div>
            <div class="modal-body" id="viewContent">
                <!-- المحتوى سيتم تحميله هنا -->
            </div>
        </div>
    </div>
    <!-- Modal لعرض سجل أعطال الحافلة -->
    <div class="modal" id="busHistoryModal">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-history"></i> سجل أعطال الحافلة <span id="busHistoryTitle"></span></h3>
                <button class="close-btn" onclick="closeModal('busHistoryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="busHistoryContent">
                    <!-- المحتوى سيتم تحميله هنا -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-info" id="exportBusHistoryBtn">
                    <i class="fas fa-file-excel"></i> تصدير السجل
                </button>
                <button class="btn btn-danger" onclick="closeModal('busHistoryModal')">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>
    <!-- Modal لإعدادات SLA -->
    <div class="modal" id="slaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-cog"></i> إعدادات SLA</h3>
                <button class="close-btn" onclick="closeModal('slaModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="sla-level high">
                    <div class="sla-title"><i class="fas fa-exclamation-circle"></i> مستوى عالي</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>الساعات</label>
                            <input type="number" id="highHours" class="form-control" min="0" max="24" value="1">
                        </div>
                        <div class="form-group">
                            <label>الدقائق</label>
                            <input type="number" id="highMinutes" class="form-control" min="0" max="59" value="0">
                        </div>
                    </div>
                </div>
                <div class="sla-level medium">
                    <div class="sla-title"><i class="fas fa-clock"></i> مستوى متوسط</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>الساعات</label>
                            <input type="number" id="mediumHours" class="form-control" min="0" max="24" value="2">
                        </div>
                        <div class="form-group">
                            <label>الدقائق</label>
                            <input type="number" id="mediumMinutes" class="form-control" min="0" max="59" value="0">
                        </div>
                    </div>
                </div>
                <div class="sla-level normal">
                    <div class="sla-title"><i class="fas fa-check-circle"></i> مستوى عادي</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>الساعات</label>
                            <input type="number" id="normalHours" class="form-control" min="0" max="24" value="4">
                        </div>
                        <div class="form-group">
                            <label>الدقائق</label>
                            <input type="number" id="normalMinutes" class="form-control" min="0" max="59" value="0">
                        </div>
                    </div>
                </div>
                <div class="sla-level stop">
                    <div class="sla-title"><i class="fas fa-ban"></i> مسار متوقف</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>الساعات</label>
                            <input type="number" id="stopHours" class="form-control" min="0" max="24" value="0">
                        </div>
                        <div class="form-group">
                            <label>الدقائق</label>
                            <input type="number" id="stopMinutes" class="form-control" min="0" max="59" value="30">
                        </div>
                    </div>
                </div>
                <div class="sla-level violation">
                    <div class="sla-title"><i class="fas fa-exclamation-triangle"></i> مخالفة تطوير</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>الساعات</label>
                            <input type="number" id="violationHours" class="form-control" min="0" max="24" value="0">
                        </div>
                        <div class="form-group">
                            <label>الدقائق</label>
                            <input type="number" id="violationMinutes" class="form-control" min="0" max="59" value="15">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="saveSlaSettings">
                    <i class="fas fa-save"></i> حفظ الإعدادات
                </button>
                <button class="btn btn-danger" onclick="closeModal('slaModal')">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    </div>
    <!-- Modal الجديد لإعدادات الإغلاق التلقائي -->
    <div class="modal" id="autoCloseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-clock"></i> إعدادات الإغلاق التلقائي</h3>
                <button class="close-btn" onclick="closeModal('autoCloseModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="auto-close-section">
                    <div class="auto-close-title">
                        <i class="fas fa-exclamation-triangle"></i> إعدادات الإغلاق التلقائي للبلاغات المتأخرة
                    </div>
                    <p style="margin-bottom: 15px; color: var(--gray);">
                        يتم إغلاق البلاغات المتأخرة تلقائياً بعد مدة زمنية محددة.
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label>عدد الأيام</label>
                            <input type="number" id="closeDays" class="form-control" min="0" max="365" value="1">
                        </div>
                        <div class="form-group">
                            <label>عدد الساعات</label>
                            <input type="number" id="closeHours" class="form-control" min="0" max="23" value="0">
                        </div>
                    </div>
                </div>
                <div class="auto-close-section">
                    <div class="auto-close-title">
                        <i class="fas fa-archive"></i> إعدادات الأرشفة التلقائية
                    </div>
                    <p style="margin-bottom: 15px; color: var(--gray);">
                        يتم أرشفة البلاغات القديمة تلقائياً بعد مدة زمنية محددة.
                    </p>
                    <div class="form-row">
                        <div class="form-group">
                            <label>عدد الأيام</label>
                            <input type="number" id="archiveDays" class="form-control" min="0" max="365" value="30">
                        </div>
                        <div class="form-group">
                            <label>عدد الساعات</label>
                            <input type="number" id="archiveHours" class="form-control" min="0" max="23" value="0">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" id="saveAutoCloseSettings">
                    <i class="fas fa-save"></i> حفظ الإعدادات
                </button>
                <button class="btn btn-danger" onclick="closeModal('autoCloseModal')">
                    <i class="fas fa-times"></i> إلغاء
                </button>
            </div>
        </div>
    </div>
    <!-- Modal لعرض التقرير -->
    <div class="modal" id="reportModal">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-file-alt"></i> تقرير البلاغات</h3>
                <button class="close-btn" onclick="closeModal('reportModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table id="reportTable">
                        <thead>
                            <tr>
                                <th>رقم البلاغ</th>
                                <th>التاريخ</th>
                                <th>رقم الحافلة</th>
                                <th>نوع العطل</th>
                                <th>الوصف</th>
                                <th>الأهمية</th>
                                <th>الحالة</th>
                                <th>الوقت المتبقي</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                            <!-- البيانات سيتم تحميلها هنا -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-info" id="exportReportBtn">
                    <i class="fas fa-file-excel"></i> تصدير التقرير
                </button>
                <button class="btn btn-danger" onclick="closeModal('reportModal')">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>
    <!-- Toast للإشعارات -->
    <div id="toast" class="toast"></div>
    <!-- عنصر صوتي للتنبيهات -->
    <audio id="alertSound" preload="auto">
        <source src="https://assets.mixkit.co/active_storage/sfx/286/286-preview.mp3" type="audio/mpeg">
    </audio>
    <script>
        // ===== الإعدادات والدوال الأساسية =====
        const CONFIG = {
            APPS_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbymRaHFUJekEzPSgK6BOkO5aMiMBJY6vFajjnCcYtHg7S7ECDsONzCeMLPdY50xRjw7/exec',
            REFRESH_INTERVAL: 30000,
            ADMIN_PASSWORD: '0000'
        };
        const STATE_FLOW = {
            'بلاغ جديد': ['تم الاستلام'],
            'تم الاستلام': ['جاري الإصلاح'],
            'جاري الإصلاح': ['تم الإصلاح', 'لم يتم الإصلاح', 'مغلق', 'انتظار توفر قطع غيار', 'عدم توفر قطع غيار', 'انتظار الموافقة'],
            'لم يتم الإصلاح': ['جاري الإصلاح', 'تم الإصلاح', 'مغلق'],
            'تم الإصلاح': [],
            'مغلق': [],
            'انتظار توفر قطع غيار': ['جاري الإصلاح', 'لم يتم الإصلاح', 'تم الإصلاح', 'مغلق'],
            'عدم توفر قطع غيار': ['جاري الإصلاح', 'لم يتم الإصلاح', 'تم الإصلاح', 'مغلق'],
            'انتظار الموافقة': ['جاري الإصلاح', 'لم يتم الإصلاح', 'تم الإصلاح', 'مغلق']
        };
        const STATE_INFO = {
            'بلاغ جديد': { icon: '🆕', class: 'status-new' },
            'تم الاستلام': { icon: '📥', class: 'status-received' },
            'جاري الإصلاح': { icon: '🔧', class: 'status-repairing' },
            'تم الإصلاح': { icon: '✅', class: 'status-fixed' },
            'لم يتم الإصلاح': { icon: '❌', class: 'status-not-fixed' },
            'انتظار توفر قطع غيار': { icon: '⏳', class: 'status-waiting' },
            'عدم توفر قطع غيار': { icon: '🚫', class: 'status-waiting' },
            'انتظار الموافقة': { icon: '📝', class: 'status-waiting' },
            'مغلق': { icon: '🔒', class: 'status-closed' }
        };
        let SLA_SETTINGS = {
            'عادي': 240,
            'متوسط': 120,
            'عالي': 60,
            'مسار متوقف': 30,
            'مخالفة تطوير': 15
        };
        let AUTO_CLOSE_SETTINGS = {
            closeDays: 1,
            closeHours: 0,
            archiveDays: 30,
            archiveHours: 0
        };
        let allReports = [];
        let selectedRow = null;
        let alertedReports = new Set();
        let monthlyDuplicates = {};
        let pendingAction = null;
        let currentBusHistory = [];
        // ===== دوال الأمان =====
        function showPasswordModal(action) {
            pendingAction = action;
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').classList.remove('show');
            document.getElementById('passwordModal').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('passwordInput').focus();
            }, 100);
        }
        function verifyPassword() {
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('passwordError');
            if (password === CONFIG.ADMIN_PASSWORD) {
                closeModal('passwordModal');
                errorDiv.classList.remove('show');
                if (pendingAction) {
                    pendingAction();
                    pendingAction = null;
                }
                showToast('✅ تم التحقق بنجاح', 'success');
            } else {
                errorDiv.classList.add('show');
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
                showToast('❌ كلمة المرور غير صحيحة', 'error');
            }
        }
        function togglePassword() {
            const input = document.getElementById('passwordInput');
            const icon = document.getElementById('passwordToggleIcon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }
        // ===== دوال إعدادات SLA =====
        function loadLocalSlaSettings() {
            const saved = localStorage.getItem('slaSettings');
            if (saved) {
                try {
                    SLA_SETTINGS = JSON.parse(saved);
                } catch (e) {
                    console.error('خطأ في تحميل إعدادات SLA:', e);
                }
            }
        }
        function saveLocalSlaSettings() {
            const normalHours = parseInt(document.getElementById('normalHours').value) || 0;
            const normalMinutes = parseInt(document.getElementById('normalMinutes').value) || 0;
            const mediumHours = parseInt(document.getElementById('mediumHours').value) || 0;
            const mediumMinutes = parseInt(document.getElementById('mediumMinutes').value) || 0;
            const highHours = parseInt(document.getElementById('highHours').value) || 0;
            const highMinutes = parseInt(document.getElementById('highMinutes').value) || 0;
            const stopHours = parseInt(document.getElementById('stopHours').value) || 0;
            const stopMinutes = parseInt(document.getElementById('stopMinutes').value) || 0;
            const violationHours = parseInt(document.getElementById('violationHours').value) || 0;
            const violationMinutes = parseInt(document.getElementById('violationMinutes').value) || 0;
            if (normalHours < 0 || normalMinutes < 0 || normalMinutes > 59 ||
                mediumHours < 0 || mediumMinutes < 0 || mediumMinutes > 59 ||
                highHours < 0 || highMinutes < 0 || highMinutes > 59 ||
                stopHours < 0 || stopMinutes < 0 || stopMinutes > 59 ||
                violationHours < 0 || violationMinutes < 0 || violationMinutes > 59) {
                showToast('❌ يرجى إدخال قيم صحيحة للوقت', 'error');
                return;
            }
            SLA_SETTINGS = {
                'عادي': (normalHours * 60) + normalMinutes,
                'متوسط': (mediumHours * 60) + mediumMinutes,
                'عالي': (highHours * 60) + highMinutes,
                'مسار متوقف': (stopHours * 60) + stopMinutes,
                'مخالفة تطوير': (violationHours * 60) + violationMinutes
            };
            localStorage.setItem('slaSettings', JSON.stringify(SLA_SETTINGS));
            showToast('✅ تم حفظ إعدادات SLA محلياً', 'success');
            closeModal('slaModal');
            renderReports();
            updateSummary();
        }
        // ===== دوال إعدادات الإغلاق التلقائي =====
        function loadAutoCloseSettings() {
            const saved = localStorage.getItem('autoCloseSettings');
            if (saved) {
                try {
                    AUTO_CLOSE_SETTINGS = JSON.parse(saved);
                } catch (e) {
                    console.error('خطأ في تحميل إعدادات الإغلاق التلقائي:', e);
                }
            }
        }
        function saveAutoCloseSettings() {
            const closeDays = parseInt(document.getElementById('closeDays').value) || 0;
            const closeHours = parseInt(document.getElementById('closeHours').value) || 0;
            const archiveDays = parseInt(document.getElementById('archiveDays').value) || 0;
            const archiveHours = parseInt(document.getElementById('archiveHours').value) || 0;
            if (closeDays < 0 || closeHours < 0 || closeHours > 23 ||
                archiveDays < 0 || archiveHours < 0 || archiveHours > 23) {
                showToast('❌ يرجى إدخال قيم صحيحة للوقت', 'error');
                return;
            }
            AUTO_CLOSE_SETTINGS = {
                closeDays,
                closeHours,
                archiveDays,
                archiveHours
            };
            localStorage.setItem('autoCloseSettings', JSON.stringify(AUTO_CLOSE_SETTINGS));
            showToast('✅ تم حفظ إعدادات الإغلاق التلقائي', 'success');
            closeModal('autoCloseModal');
        }
        function openAutoCloseSettings() {
            const openModal = () => {
                document.getElementById('closeDays').value = AUTO_CLOSE_SETTINGS.closeDays;
                document.getElementById('closeHours').value = AUTO_CLOSE_SETTINGS.closeHours;
                document.getElementById('archiveDays').value = AUTO_CLOSE_SETTINGS.archiveDays;
                document.getElementById('archiveHours').value = AUTO_CLOSE_SETTINGS.archiveHours;
                document.getElementById('autoCloseModal').style.display = 'flex';
            };
            showPasswordModal(openModal);
        }
        // ===== دوال التحميل والأداء =====
        function showLoading(message = 'جاري تحميل البيانات...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            text.textContent = message;
            overlay.classList.add('active');
        }
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
        }
        async function loadReports(silent = false) {
            if (!silent) showLoading('جاري تحديث البيانات...');
            try {
                const response = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=getReports&t=${Date.now()}`);
                const data = await response.json();
                if (data.status === 'success') {
                    allReports = data.data;
                    calculateMonthlyDuplicates();
                    renderReports();
                    updateSummary();
                    checkAlerts();
                    if (!silent) showToast('✅ تم تحميل البيانات بنجاح', 'success');
                } else {
                    throw new Error(data.data);
                }
            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                if (!silent) showToast('❌ فشل في تحميل البيانات', 'error');
            } finally {
                if (!silent) hideLoading();
            }
        }
        // ===== دوال معالجة البيانات =====
        function calculateMonthlyDuplicates() {
            monthlyDuplicates = {};
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            allReports.forEach(report => {
                const busNumber = report['رقم الحافلة'];
                if (!busNumber) return;
                const reportDate = new Date(report['التاريخ'] || report['وقت الإنشاء']);
                if (reportDate.getMonth() === currentMonth && reportDate.getFullYear() === currentYear) {
                    monthlyDuplicates[busNumber] = (monthlyDuplicates[busNumber] || 0) + 1;
                }
            });
        }
        // ===== دوال العد التنازلي =====
        function getCountdownInfo(r) {
            const hideCountdownStates = ['لم يتم الإصلاح', 'مغلق', 'تم الإصلاح', 'انتظار توفر قطع غيار', 'عدم توفر قطع غيار', 'انتظار الموافقة'];
            if (hideCountdownStates.includes(r['الحالة'])) {
                return { 
                    text: '-', 
                    cls: '', 
                    rowCls: '', 
                    progress: 0, 
                    showCountdown: false 
                };
            }
            const showCountdownStates = ['تم الاستلام', 'جاري الإصلاح'];
            if (!showCountdownStates.includes(r['الحالة'])) {
                return { 
                    text: '-', 
                    cls: '', 
                    rowCls: '', 
                    progress: 0, 
                    showCountdown: false 
                };
            }
            const priority = r['مستوى الأهمية'];
            const slaTime = SLA_SETTINGS[priority] || 240;
            const start = new Date(r['وقت آخر تحديث'] || r['وقت الإنشاء']);
            const diff = (Date.now() - start.getTime()) / 60000;
            const remain = Math.round(slaTime - diff);
            const pct = Math.max(0, Math.min(100, ((slaTime - diff) / slaTime) * 100));
            let color = 'green';
            if (pct <= 50) color = 'orange';
            if (pct <= 10) color = 'red';
            if (remain <= 0) return { 
                text: '⚠️ متأخر', 
                cls: 'urgent', 
                rowCls: 'tr-urgent', 
                progress: 0, 
                color: 'red', 
                blink: true, 
                label: 'انتهى',
                isLate: true,
                showCountdown: true
            };
            if (remain <= 10) return { 
                text: `${remain} دقيقة`, 
                cls: 'warning', 
                rowCls: 'tr-warning', 
                progress: pct, 
                color, 
                blink: false, 
                label: `${remain} د`,
                isLate: false,
                showCountdown: true
            };
            return { 
                text: `${remain} دقيقة`, 
                cls: '', 
                rowCls: '', 
                progress: pct, 
                color, 
                blink: false, 
                label: `${remain} د`,
                isLate: false,
                showCountdown: true
            };
        }
        function checkAlerts() {
            allReports.forEach(r => {
                const countdownInfo = getCountdownInfo(r);
                if (countdownInfo.isLate && !alertedReports.has(r.rowId)) {
                    alertedReports.add(r.rowId);
                    playAlertSound();
                    showToast(`🚨 الحافلة ${r['رقم الحافلة']} متأخرة!`, 'warning');
                }
            });
        }
        function playAlertSound() {
            const alertSound = document.getElementById('alertSound');
            if (alertSound) {
                alertSound.play().catch(e => {
                    console.log('تعذر تشغيل الصوت:', e);
                });
            }
        }
        // ===== دوال عرض البيانات =====
        function renderReports() {
            const body = document.getElementById('reportsTableBody');
            if (!body) return;
            body.innerHTML = '';
            if (!allReports.length) {
                body.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>لا توجد بلاغات لعرضها</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            const filteredReports = filterReports();
            filteredReports.forEach(r => {
                const c = getCountdownInfo(r);
                let finalClass = '';
                if (['تم الإصلاح', 'مغلق'].includes(r['الحالة'])) {
                    finalClass = 'tr-final';
                }
                if (c.rowCls) finalClass = c.rowCls || finalClass;
                const pr = r['مستوى الأهمية'];
                let pClass = 'priority-normal';
                if (pr === 'عالي') pClass = 'priority-high';
                else if (pr === 'متوسط') pClass = 'priority-medium';
                else if (pr === 'مسار متوقف') pClass = 'priority-stop';
                else if (pr === 'مخالفة تطوير') pClass = 'priority-violation';
                const progressBar = c.showCountdown && c.progress > 0 ? 
                    `<div class="progress-bar"><div class="progress-fill ${c.color} ${c.blink ? 'blink' : ''}" style="width:${c.progress}%;">${c.label}</div></div>` : '';
                const formattedDate = formatTo12Hour(r['التاريخ'] || r['وقت الإنشاء'] || '');
                const tr = document.createElement('tr');
                tr.className = finalClass;
                tr.innerHTML = `
                    <td>${r['رقم البلاغ'] || '---'}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <span class="bus-number-link" onclick="showBusHistory('${r['رقم الحافلة']}')">
                            ${r['رقم الحافلة'] || '-'}
                        </span>
                        ${monthlyDuplicates[r['رقم الحافلة']] > 1 ? 
                            `<span style="color: #d32f2f; font-size: 0.8rem; margin-right: 5px;" title="عدد الأعطال هذا الشهر">(${monthlyDuplicates[r['رقم الحافلة']]})</span>` : ''}
                    </td>
                    <td>${r['نوع العطل'] || '-'}</td>
                    <td>${r['وصف العطل'] || '-'}</td>
                    <td class="${pClass}">${r['مستوى الأهمية'] || '-'}</td>
                    <td>
                        <span class="status-badge ${STATE_INFO[r['الحالة']]?.class || ''}">
                            ${STATE_INFO[r['الحالة']]?.icon || ''} ${r['الحالة']}
                        </span>
                    </td>
                    <td class="countdown ${c.cls}">
                        ${c.showCountdown ? c.text : '-'}
                        ${progressBar}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view" onclick="viewDetails(${r.rowId})" title="عرض التفاصيل">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-action btn-wa" onclick="sendWhatsApp(${r.rowId})" title="إرسال واتساب">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="requestDeleteReport(${r.rowId})" title="حذف البلاغ">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>`;
                body.appendChild(tr);
            });
        }
        function formatTo12Hour(dateTimeStr) {
            if (!dateTimeStr) return '-';
            try {
                const date = new Date(dateTimeStr);
                if (isNaN(date.getTime())) return dateTimeStr;
                let hours = date.getHours();
                let minutes = date.getMinutes();
                const ampm = hours >= 12 ? 'م' : 'ص';
                hours = hours % 12;
                hours = hours ? hours : 12;
                minutes = minutes < 10 ? '0' + minutes : minutes;
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${year}-${month}-${day} ${hours}:${minutes} ${ampm}`;
            } catch (e) {
                return dateTimeStr;
            }
        }
        function filterReports() {
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('statusFilter')?.value || '';
            const priorityFilter = document.getElementById('priorityFilter')?.value || '';
            let filtered = allReports;
            if (searchTerm) {
                filtered = filtered.filter(r => 
                    (r['رقم الحافلة'] && r['رقم الحافلة'].toString().includes(searchTerm)) ||
                    (r['نوع العطل'] && r['نوع العطل'].toLowerCase().includes(searchTerm)) ||
                    (r['وصف العطل'] && r['وصف العطل'].toLowerCase().includes(searchTerm))
                );
            }
            if (statusFilter) {
                if (statusFilter === 'متأخر') {
                    filtered = filtered.filter(r => {
                        const countdownInfo = getCountdownInfo(r);
                        return countdownInfo.isLate;
                    });
                } else {
                    filtered = filtered.filter(r => r['الحالة'] === statusFilter);
                }
            }
            if (priorityFilter) {
                filtered = filtered.filter(r => r['مستوى الأهمية'] === priorityFilter);
            }
            return filtered;
        }
        function updateSummary() {
            const total = allReports.length;
            const newReports = allReports.filter(r => r['الحالة'] === 'بلاغ جديد').length;
            const late = allReports.filter(r => {
                const countdownInfo = getCountdownInfo(r);
                return countdownInfo.isLate;
            }).length;
            const stopped = allReports.filter(r => r['مستوى الأهمية'] === 'مسار متوقف').length;
            const dup = countDuplicates(allReports.map(r => r['رقم الحافلة']));
            document.getElementById('newCount').innerText = newReports;
            document.getElementById('lateCount').innerText = late;
            document.getElementById('stoppedCount').innerText = stopped;
            document.getElementById('duplicateCount').innerText = dup;
            document.getElementById('totalCount').innerText = total;
        }
        function countDuplicates(arr) {
            const f = {};
            let d = 0;
            arr.forEach(n => {
                if (!n) return;
                f[n] = (f[n] || 0) + 1;
            });
            for (const k in f) if (f[k] > 1) d++;
            return d;
        }
        // ===== دوال عرض التفاصيل وتغيير الحالة =====
        function viewDetails(id) {
            const r = allReports.find(x => x.rowId === id);
            if (!r) return;
            selectedRow = id;
            let expectedDurationDisplay = r['مدة الإصلاح المتوقعة']?.trim() || 'لا يوجد';
            let partsNotesDisplay = r['قطع الغيار التي تم تركيبها']?.trim() || 'لا يوجد';
            let notesDisplay = r['الملاحظات']?.trim() || 'لا يوجد';
            const viewContent = document.getElementById('viewContent');
            viewContent.innerHTML = `
                <div class="detail-grid">
                    <div class="detail-section">
                        <h4><i class="fas fa-info-circle"></i> المعلومات الأساسية</h4>
                        <div class="detail-item">
                            <span class="detail-label">رقم البلاغ:</span>
                            <span class="detail-value">${r['رقم البلاغ'] || '---'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">التاريخ:</span>
                            <span class="detail-value">${formatTo12Hour(r['التاريخ'] || r['وقت الإنشاء'] || '')}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">رقم الحافلة:</span>
                            <span class="detail-value">${r['رقم الحافلة'] || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">نوع العطل:</span>
                            <span class="detail-value">${r['نوع العطل'] || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">الأهمية:</span>
                            <span class="detail-value ${getPriorityClass(r['مستوى الأهمية'])}">${r['مستوى الأهمية'] || '-'}</span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <h4><i class="fas fa-file-alt"></i> تفاصيل البلاغ</h4>
                        <div class="detail-item">
                            <span class="detail-label">الوصف:</span>
                            <span class="detail-value">${r['وصف العطل'] || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">الموقع:</span>
                            <span class="detail-value">${r['الموقع الحالي'] || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">رقم الجوال:</span>
                            <span class="detail-value">${r['رقم الجوال'] || '-'}</span>
                        </div>
                    </div>
                    <div class="detail-section">
                        <h4><i class="fas fa-sync-alt"></i> حالة البلاغ</h4>
                        <div class="detail-item">
                            <span class="detail-label">الحالة الحالية:</span>
                            <span class="detail-value">
                                <span class="status-badge ${STATE_INFO[r['الحالة']]?.class || ''}">
                                    ${STATE_INFO[r['الحالة']]?.icon || ''} ${r['الحالة']}
                                </span>
                            </span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">آخر تحديث:</span>
                            <span class="detail-value">${formatTo12Hour(r['وقت آخر تحديث'] || r['وقت الإنشاء'] || '')}</span>
                        </div>
                        ${getCountdownInfo(r).showCountdown ? `
                        <div class="detail-item">
                            <span class="detail-label">الوقت المتبقي:</span>
                            <span class="detail-value countdown ${getCountdownInfo(r).cls}">${getCountdownInfo(r).text}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
                <div class="detail-section">
                    <h4><i class="fas fa-clock"></i> مدة الإصلاح المتوقعة</h4>
                    <div class="detail-item">
                        <span class="detail-value" style="background: #fff8e1; padding: 10px; border-radius: 5px; border-right: 3px solid #ff9800;">${expectedDurationDisplay}</span>
                    </div>
                </div>
                <div class="detail-section">
                    <h4><i class="fas fa-cogs"></i> قطع الغيار التي تم تركيبها</h4>
                    <div class="detail-item">
                        <span class="detail-value" style="background: #e3f2fd; padding: 10px; border-radius: 5px; border-right: 3px solid #1976d2;">${partsNotesDisplay}</span>
                    </div>
                </div>
                <div class="detail-section">
                    <h4><i class="fas fa-sticky-note"></i> الملاحظات</h4>
                    <div class="detail-item">
                        <span class="detail-value" style="background: #e8f5e9; padding: 10px; border-radius: 5px; border-right: 3px solid #4caf50;">${notesDisplay}</span>
                    </div>
                </div>
                ${monthlyDuplicates[r['رقم الحافلة']] > 1 ? `
                <div class="detail-section">
                    <h4><i class="fas fa-chart-bar"></i> الإحصائيات</h4>
                    <div class="detail-item">
                        <span class="detail-label">عدد الأعطال هذا الشهر:</span>
                        <span class="detail-value" style="color: #d32f2f; font-weight: bold;">${monthlyDuplicates[r['رقم الحافلة']]} عطل</span>
                    </div>
                </div>
                ` : ''}
                <div class="detail-section" style="background: white; border: 2px solid var(--primary-light);">
                    <h4><i class="fas fa-edit"></i> تغيير حالة البلاغ</h4>
                    <div class="form-group">
                        <label for="statusSelect">الحالة الجديدة</label>
                        <select id="statusSelect" class="form-control" onchange="updateNotesField()">
                            <option value="">اختر الحالة الجديدة</option>
                        </select>
                    </div>
                    <div class="form-group notes-field" id="notesField">
                        <!-- سيتم تعبئة هذا الحقل ديناميكياً -->
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-warning" onclick="updateReportStatus()">
                            <i class="fas fa-check"></i> تأكيد التغيير
                        </button>
                        <button class="btn btn-danger" onclick="closeModal('viewModal')">
                            <i class="fas fa-times"></i> إغلاق
                        </button>
                    </div>
                </div>
            `;
            populateStatusOptions(r['الحالة']);
            document.getElementById('viewModal').style.display = 'flex';
        }
        function getPriorityClass(priority) {
            switch(priority) {
                case 'عالي': return 'priority-high';
                case 'متوسط': return 'priority-medium';
                case 'مسار متوقف': return 'priority-stop';
                case 'مخالفة تطوير': return 'priority-violation';
                default: return 'priority-normal';
            }
        }
        function populateStatusOptions(currentState) {
            const select = document.getElementById('statusSelect');
            select.innerHTML = '<option value="">اختر الحالة الجديدة</option>';
            const allowedStates = STATE_FLOW[currentState] || [];
            allowedStates.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                select.appendChild(option);
            });
            if (allowedStates.length === 0) {
                select.disabled = true;
                select.innerHTML = '<option value="">لا يمكن تغيير هذه الحالة</option>';
            } else {
                select.disabled = false;
            }
        }
        function updateNotesField() {
            const selectedState = document.getElementById('statusSelect').value;
            const notesField = document.getElementById('notesField');
            if (!selectedState) {
                notesField.innerHTML = '';
                notesField.className = 'form-group notes-field';
                return;
            }
            let fieldHTML = '';
            if (['جاري الإصلاح', 'انتظار توفر قطع غيار', 'عدم توفر قطع غيار', 'انتظار الموافقة'].includes(selectedState)) {
                fieldHTML = `
                    <label for="expectedDuration"><i class="fas fa-clock"></i> مدة الإصلاح المتوقعة</label>
                    <textarea id="expectedDuration" class="form-control" placeholder="أدخل مدة الإصلاح المتوقعة..."></textarea>
                `;
            } else if (selectedState === 'تم الإصلاح') {
                fieldHTML = `
                    <label for="spareParts"><i class="fas fa-cogs"></i> قطع الغيار التي تم تركيبها</label>
                    <textarea id="spareParts" class="form-control" placeholder="أدخل قطع الغيار التي تم تركيبها..."></textarea>
                `;
            } else {
                fieldHTML = `
                    <label for="generalNotes"><i class="fas fa-sticky-note"></i> الملاحظات</label>
                    <textarea id="generalNotes" class="form-control" placeholder="أدخل الملاحظات..."></textarea>
                `;
            }
            notesField.innerHTML = `<div class="form-group">${fieldHTML}</div>`;
            notesField.className = 'form-group notes-field active';
        }
        async function updateReportStatus() {
            const newState = document.getElementById('statusSelect').value;
            if (!newState) {
                showToast('❌ يرجى اختيار حالة جديدة', 'error');
                return;
            }
            const expectedDuration = document.getElementById('expectedDuration')?.value || '';
            const spareParts = document.getElementById('spareParts')?.value || '';
            const generalNotes = document.getElementById('generalNotes')?.value || '';
            showLoading('جاري تحديث حالة البلاغ...');
            try {
                const updateTime = new Date().toISOString();
                const url = new URL(CONFIG.APPS_SCRIPT_URL);
                url.searchParams.append('action', 'updateStatus');
                url.searchParams.append('rowIndex', selectedRow);
                url.searchParams.append('newState', newState);
                url.searchParams.append('updateTime', updateTime);
                url.searchParams.append('expectedDuration', expectedDuration);
                url.searchParams.append('spareParts', spareParts);
                url.searchParams.append('generalNotes', generalNotes);
                const res = await fetch(url);
                const j = await res.json();
                if (j.status === 'success') {
                    allReports = j.data;
                    renderReports();
                    updateSummary();
                    closeModal('viewModal');
                    showToast('✅ تم تحديث الحالة بنجاح - العد التنازلي سيبدأ من جديد', 'success');
                } else {
                    throw new Error(j.data);
                }
            } catch (e) {
                console.error('خطأ في تحديث الحالة:', e);
                showToast('❌ ' + e.message, 'error');
            } finally {
                hideLoading();
            }
        }
        // ===== دوال سجل أعطال الحافلة =====
        function showBusHistory(busNumber) {
            const busReports = allReports.filter(r => r['رقم الحافلة'] === busNumber);
            if (busReports.length === 0) {
                showToast('❌ لا توجد أعطال مسجلة لهذه الحافلة', 'warning');
                return;
            }
            currentBusHistory = busReports;
            document.getElementById('busHistoryTitle').textContent = `(${busNumber})`;
            let historyHTML = `
                <p style="margin-bottom: 20px; font-size: 1.1rem; color: var(--primary);">
                    <i class="fas fa-chart-bar"></i> عدد الأعطال المسجلة: <strong>${busReports.length}</strong>
                </p>
                <div class="table-container">
                    <table style="width: 100%; border-collapse: collapse; min-width: 1000px;">
                        <thead>
                            <tr style="background: var(--primary-light);">
                                <th style="padding: 12px; border: 1px solid var(--border);">رقم البلاغ</th>
                                <th style="padding: 12px; border: 1px solid var(--border);">التاريخ</th>
                                <th style="padding: 12px; border: 1px solid var(--border);">نوع العطل</th>
                                <th style="padding: 12px; border: 1px solid var(--border);">وصف العطل</th>
                                <th style="padding: 12px; border: 1px solid var(--border);">الملاحظات</th>
                                <th style="padding: 12px; border: 1px solid var(--border);">قطع الغيار التي تم تركيبها</th>
                                <th style="padding: 12px; border: 1px solid var(--border);">مدة معالجة العطل</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            busReports.forEach(report => {
                let partsNotesDisplay = report['قطع الغيار التي تم تركيبها']?.trim() || 'لا يوجد';
                let notesDisplay = report['الملاحظات']?.trim() || 'لا يوجد';
                const repairDuration = calculateRepairDuration(report);
                historyHTML += `
                    <tr>
                        <td style="padding: 10px; border: 1px solid var(--border);">${report['رقم البلاغ'] || '---'}</td>
                        <td style="padding: 10px; border: 1px solid var(--border);">${formatTo12Hour(report['التاريخ'] || report['وقت الإنشاء'] || '')}</td>
                        <td style="padding: 10px; border: 1px solid var(--border);">${report['نوع العطل'] || '-'}</td>
                        <td style="padding: 10px; border: 1px solid var(--border);">${report['وصف العطل'] || '-'}</td>
                        <td style="padding: 10px; border: 1px solid var(--border);">${notesDisplay}</td>
                        <td style="padding: 10px; border: 1px solid var(--border);">${partsNotesDisplay}</td>
                        <td style="padding: 10px; border: 1px solid var(--border);">${repairDuration}</td>
                    </tr>
                `;
            });
            historyHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            document.getElementById('busHistoryContent').innerHTML = historyHTML;
            document.getElementById('busHistoryModal').style.display = 'flex';
        }
        function calculateRepairDuration(report) {
            const startDate = new Date(report['التاريخ'] || report['وقت الإنشاء']);
            const finalStates = ['تم الإصلاح', 'مغلق', 'انتظار توفر قطع غيار', 'عدم توفر قطع غيار', 'انتظار الموافقة'];
            if (finalStates.includes(report['الحالة'])) {
                const endDate = new Date(report['وقت آخر تحديث'] || report['التاريخ'] || report['وقت الإنشاء']);
                const durationMs = endDate - startDate;
                if (durationMs > 0) {
                    const days = Math.floor(durationMs / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((durationMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
                    if (days > 0) {
                        return `${days} يوم ${hours} ساعة`;
                    } else if (hours > 0) {
                        return `${hours} ساعة ${minutes} دقيقة`;
                    } else {
                        return `${minutes} دقيقة`;
                    }
                }
            }
            return 'لم تنته بعد';
        }
        function exportBusHistory() {
            if (!currentBusHistory.length) {
                showToast('❌ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            try {
                const ws = XLSX.utils.json_to_sheet(currentBusHistory.map(report => {
                    let partsNotesDisplay = report['قطع الغيار التي تم تركيبها']?.trim() || 'لا يوجد';
                    let notesDisplay = report['الملاحظات']?.trim() || 'لا يوجد';
                    return {
                        'رقم البلاغ': report['رقم البلاغ'] || '',
                        'التاريخ': formatTo12Hour(report['التاريخ'] || report['وقت الإنشاء'] || ''),
                        'رقم الحافلة': report['رقم الحافلة'] || '',
                        'نوع العطل': report['نوع العطل'] || '',
                        'وصف العطل': report['وصف العطل'] || '',
                        'الملاحظات': notesDisplay,
                        'قطع الغيار التي تم تركيبها': partsNotesDisplay,
                        'مدة معالجة العطل': calculateRepairDuration(report),
                        'الأهمية': report['مستوى الأهمية'] || '',
                        'الموقع': report['الموقع الحالي'] || ''
                    };
                }));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'سجل الأعطال');
                const busNumber = currentBusHistory[0]?.['رقم الحافلة'] || 'غير معروف';
                const fileName = `سجل_أعطال_الحافلة_${busNumber}_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showToast('✅ تم تصدير سجل الأعطال بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في تصدير السجل:', error);
                showToast('❌ فشل في تصدير السجل', 'error');
            }
        }


        // ===== دالة إرسال واتساب معدّلة حسب المتطلبات =====
        function sendWhatsApp(id) {
    const r = allReports.find(x => x.rowId === id);
    if (!r) return;

    // تنسيق الوقت باستخدام نفس دالة النظام
    const timeStr = formatTo12Hour(r['وقت آخر تحديث'] || r['التاريخ'] || r['وقت الإنشاء'] || '');
    const locationText = r['الموقع الحالي'] || 'غير محدد';
    const isOutside = r['الموقع الحالي'] === 'خارج الكراج';

    let message = '';

    switch (r['الحالة']) {
        case 'تم الإصلاح':
            message = `🔔 *حالة البلاغ (${r['الحالة']})*\n\n`;
            message += `*🚍 رقم البلاغ:* ${r['رقم البلاغ'] || '---'}\n`;
            message += `*🚌 رقم الحافلة:* ${r['رقم الحافلة'] || 'غير معروف'}\n`;
            message += `*🔧 نوع العطل:* ${r['نوع العطل'] || 'غير محدد'}\n`;
            message += `*📝 الوصف:* ${r['وصف العطل'] || 'لا يوجد'}\n`;
            message += `*📍 الموقع:* ${locationText}\n`;
            if (r['رقم الجوال']) {
                message += `*📞 الجوال:* ${r['رقم الجوال']}\n`;
            }
            message += `*⚡ الأهمية:* ${r['مستوى الأهمية'] || 'متوسط'}\n`;
            message += `*🔔 الحالة:* ${r['الحالة']}\n`;
            message += `*🗒 الملاحظات:* ${r['الملاحظات']?.trim() || 'لا يوجد'}\n`;
            message += `*⚙ قطع الغيار التي تم تركيبها:* ${r['قطع الغيار التي تم تركيبها']?.trim() || 'لا يوجد'}\n`;
            message += `*🕓 التاريخ و الوقت:* ${timeStr}\n\n`;
            message += `⚙ نظام إدارة البلاغات`;
            break;

        case 'لم يتم الإصلاح':
            message = `❌ *${r['الحالة']}*\n\n`;
            message += `*🚍 البلاغ:* ${r['رقم البلاغ'] || '---'}\n`;
            message += `*🚌 الحافلة:* ${r['رقم الحافلة'] || 'غير معروف'}\n`;
            message += `*🔧 العطل:* ${r['نوع العطل'] || 'غير محدد'}\n`;
            message += `*📝 السبب:* ${r['الملاحظات']?.trim() || 'غير محدد'}\n`;
            message += `*📍 الموقع:* ${locationText}\n`;
            message += `*⚡ الأهمية:* ${r['مستوى الأهمية'] || 'متوسط'}\n`;
            message += `*🕓 وقت التحديث:* ${timeStr}\n\n`;
            message += `⚙ نظام إدارة البلاغات`;
            break;

        case 'مغلق':
            message = `🔒 *البلاغ مغلق*\n\n`;
            message += `*🚍 رقم البلاغ:* ${r['رقم البلاغ'] || '---'}\n`;
            message += `*🚌 الحافلة:* ${r['رقم الحافلة'] || 'غير معروف'}\n`;
            message += `*📌 السبب:* ${r['الملاحظات']?.trim() || 'تم الإغلاق بعد المراجعة'}\n`;
            message += `*📍 الموقع:* ${locationText}\n`;
            message += `*🕓 وقت الإغلاق:* ${timeStr}\n\n`;
            message += `⚙ نظام إدارة البلاغات`;
            break;

        case 'بلاغ جديد':
            if (isOutside) {
                message = `*🔔 بلاغ جديد تم تسجيله (خارج الكراج)*\n`;
                message += `*🚍 رقم البلاغ:* ${r['رقم البلاغ'] || '---'}\n`;
                message += `*🚌 رقم الحافلة:* ${r['رقم الحافلة'] || 'غير معروف'}\n`;
                message += `*🔧 نوع العطل:* ${r['نوع العطل'] || 'غير محدد'}\n`;
                message += `*📝 الوصف:* ${r['وصف العطل'] || 'لا يوجد'}\n`;
                message += `*📍 الموقع:* ${locationText}\n`;
                if (r['الموقع التفصيلي']) {
                    message += `*🌍 الرابط:* ${r['الموقع التفصيلي']}\n`;
                }
                if (r['رقم الجوال']) {
                    message += `*📞 الجوال:* ${r['رقم الجوال']}\n`;
                }
                message += `*⚡ الأهمية:* ${r['مستوى الأهمية'] || 'غير محدد'}\n`;
                message += `*🕓 وقت الإنشاء:* ${timeStr}\n\n`;
                message += `⚙️ *تم إنشاء البلاغ عبر نظام إدارة البلاغات*`;
            } else {
                message = `*🔔 بلاغ جديد تم تسجيله (داخل الكراج)*\n-\n`;
                message += `*🚍 رقم البلاغ:* ${r['رقم البلاغ'] || '---'}\n`;
                message += `*🚌 رقم الحافلة:* ${r['رقم الحافلة'] || 'غير معروف'}\n`;
                message += `*🔧 نوع العطل:* ${r['نوع العطل'] || 'غير محدد'}\n`;
                message += `*📝 الوصف:* ${r['وصف العطل'] || 'لا يوجد'}\n`;
                message += `*📍 الموقع:* ${locationText}\n`;
                message += `*⚡ الأهمية:* ${r['مستوى الأهمية'] || 'غير محدد'}\n`;
                message += `*🕓 وقت الإنشاء:* ${timeStr}\n\n`;
                message += `⚙️ *تم إنشاء البلاغ عبر نظام إدارة البلاغات*`;
            }
            break;

        case 'جاري الإصلاح':
        case 'انتظار توفر قطع غيار':
        case 'عدم توفر قطع غيار':
        case 'انتظار الموافقة':
            message = `🔄 *${r['الحالة']}*\n\n`;
            message += `*🚍 البلاغ:* ${r['رقم البلاغ'] || '---'}\n`;
            message += `*🚌 الحافلة:* ${r['رقم الحافلة'] || 'غير معروف'}\n`;
            message += `*🔧 العطل:* ${r['نوع العطل'] || 'غير محدد'}\n`;
            message += `*📍 الموقع:* ${locationText}\n`;
            if (r['مدة الإصلاح المتوقعة']?.trim()) {
                message += `*⏱ المدة المتوقعة:* ${r['مدة الإصلاح المتوقعة']}\n`;
            }
            if (r['الملاحظات']?.trim()) {
                message += `*🗒 الملاحظات:* ${r['الملاحظات']}\n`;
            }
            message += `*🕓 آخر تحديث:* ${timeStr}\n\n`;
            message += `⚙ نظام إدارة البلاغات`;
            break;

        default:
            message = `📌 *حالة البلاغ: ${r['الحالة'] || '---'}*\n\n`;
            message += `*🚍 البلاغ:* ${r['رقم البلاغ'] || '---'}\n`;
            message += `*🚌 الحافلة:* ${r['رقم الحافلة'] || '---'}\n`;
            message += `*📍 الموقع:* ${locationText}\n`;
            message += `*🕓 الوقت:* ${timeStr}\n\n`;
            message += `⚙ نظام إدارة البلاغات`;
    }

    const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(url, '_blank');
}






        
        // ===== دوال الإجراءات =====
        function requestDeleteReport(id) {
            const deleteAction = () => {
                deleteReport(id);
            };
            showPasswordModal(deleteAction);
        }
        async function deleteReport(id) {
            if (!confirm('⚠️ هل أنت متأكد من حذف هذا البلاغ؟')) return;
            showLoading('جاري حذف البلاغ...');
            try {
                const res = await fetch(`${CONFIG.APPS_SCRIPT_URL}?action=deleteReport&rowIndex=${id}`);
                const j = await res.json();
                if (j.status === 'success') {
                    allReports = j.data;
                    renderReports();
                    updateSummary();
                    showToast('🗑️ تم حذف البلاغ', 'success');
                } else {
                    throw new Error(j.data);
                }
            } catch (e) {
                console.error('خطأ في حذف البلاغ:', e);
                showToast('❌ ' + e.message, 'error');
            } finally {
                hideLoading();
            }
        }
        // ===== إعدادات SLA =====
        function openSlaSettings() {
            const openModal = () => {
                document.getElementById('normalHours').value = Math.floor(SLA_SETTINGS['عادي'] / 60);
                document.getElementById('normalMinutes').value = SLA_SETTINGS['عادي'] % 60;
                document.getElementById('mediumHours').value = Math.floor(SLA_SETTINGS['متوسط'] / 60);
                document.getElementById('mediumMinutes').value = SLA_SETTINGS['متوسط'] % 60;
                document.getElementById('highHours').value = Math.floor(SLA_SETTINGS['عالي'] / 60);
                document.getElementById('highMinutes').value = SLA_SETTINGS['عالي'] % 60;
                document.getElementById('stopHours').value = Math.floor(SLA_SETTINGS['مسار متوقف'] / 60);
                document.getElementById('stopMinutes').value = SLA_SETTINGS['مسار متوقف'] % 60;
                document.getElementById('violationHours').value = Math.floor(SLA_SETTINGS['مخالفة تطوير'] / 60);
                document.getElementById('violationMinutes').value = SLA_SETTINGS['مخالفة تطوير'] % 60;
                document.getElementById('slaModal').style.display = 'flex';
            };
            showPasswordModal(openModal);
        }
        // ===== تصدير Excel =====
        function exportToExcel() {
            if (!allReports.length) {
                showToast('❌ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            try {
                const ws = XLSX.utils.json_to_sheet(allReports.map(report => {
                    let partsNotesDisplay = report['قطع الغيار التي تم تركيبها']?.trim() || 'لا يوجد';
                    let notesDisplay = report['الملاحظات']?.trim() || 'لا يوجد';
                    return {
                        'رقم البلاغ': report['رقم البلاغ'] || '',
                        'التاريخ': report['التاريخ'] || report['وقت الإنشاء'] || '',
                        'رقم الحافلة': report['رقم الحافلة'] || '',
                        'نوع العطل': report['نوع العطل'] || '',
                        'وصف العطل': report['وصف العطل'] || '',
                        'رقم الجوال': report['رقم الجوال'] || '',
                        'الموقع الحالي': report['الموقع الحالي'] || '',
                        'الموقع التفصيلي': report['الموقع التفصيلي'] || '',
                        'مستوى الأهمية': report['مستوى الأهمية'] || '',
                        'الحالة': report['الحالة'] || '',
                        'وقت الإنشاء': report['وقت الإنشاء'] || '',
                        'وقت آخر تحديث': report['وقت آخر تحديث'] || '',
                        'الملاحظات': notesDisplay,
                        'قطع الغيار التي تم تركيبها': partsNotesDisplay,
                        'مدة الإصلاح المتوقعة': report['مدة الإصلاح المتوقعة']?.trim() || ''
                    };
                }));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'بلاغات الحافلات');
                const fileName = `بلاغات_الحافلات_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showToast('✅ تم تصدير البيانات بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في التصدير:', error);
                showToast('❌ فشل في تصدير البيانات', 'error');
            }
        }
        // ===== دالة عرض التقرير =====
        function viewReport() {
            const reportBody = document.getElementById('reportTableBody');
            reportBody.innerHTML = '';
            if (!allReports.length) {
                reportBody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>لا توجد بلاغات لعرضها</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                const filteredReports = filterReports();
                filteredReports.forEach(r => {
                    const c = getCountdownInfo(r);
                    const pr = r['مستوى الأهمية'];
                    let pClass = 'priority-normal';
                    if (pr === 'عالي') pClass = 'priority-high';
                    else if (pr === 'متوسط') pClass = 'priority-medium';
                    else if (pr === 'مسار متوقف') pClass = 'priority-stop';
                    else if (pr === 'مخالفة تطوير') pClass = 'priority-violation';
                    const formattedDate = formatTo12Hour(r['التاريخ'] || r['وقت الإنشاء'] || '');
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${r['رقم البلاغ'] || '---'}</td>
                        <td>${formattedDate}</td>
                        <td>${r['رقم الحافلة'] || '-'}</td>
                        <td>${r['نوع العطل'] || '-'}</td>
                        <td>${r['وصف العطل'] || '-'}</td>
                        <td class="${pClass}">${r['مستوى الأهمية'] || '-'}</td>
                        <td>
                            <span class="status-badge ${STATE_INFO[r['الحالة']]?.class || ''}">
                                ${STATE_INFO[r['الحالة']]?.icon || ''} ${r['الحالة']}
                            </span>
                        </td>
                        <td class="countdown ${c.cls}">
                            ${c.showCountdown ? c.text : '-'}
                        </td>
                    `;
                    reportBody.appendChild(tr);
                });
            }
            document.getElementById('reportModal').style.display = 'flex';
        }
        // ===== دالة تصدير التقرير =====
        function exportReport() {
            if (!allReports.length) {
                showToast('❌ لا توجد بيانات للتصدير', 'warning');
                return;
            }
            try {
                const ws = XLSX.utils.json_to_sheet(allReports.map(report => {
                    let partsNotesDisplay = report['قطع الغيار التي تم تركيبها']?.trim() || 'لا يوجد';
                    let notesDisplay = report['الملاحظات']?.trim() || 'لا يوجد';
                    return {
                        'رقم البلاغ': report['رقم البلاغ'] || '',
                        'التاريخ': report['التاريخ'] || report['وقت الإنشاء'] || '',
                        'رقم الحافلة': report['رقم الحافلة'] || '',
                        'نوع العطل': report['نوع العطل'] || '',
                        'وصف العطل': report['وصف العطل'] || '',
                        'رقم الجوال': report['رقم الجوال'] || '',
                        'الموقع الحالي': report['الموقع الحالي'] || '',
                        'الموقع التفصيلي': report['الموقع التفصيلي'] || '',
                        'مستوى الأهمية': report['مستوى الأهمية'] || '',
                        'الحالة': report['الحالة'] || '',
                        'وقت الإنشاء': report['وقت الإنشاء'] || '',
                        'وقت آخر تحديث': report['وقت آخر تحديث'] || '',
                        'الملاحظات': notesDisplay,
                        'قطع الغيار التي تم تركيبها': partsNotesDisplay,
                        'مدة الإصلاح المتوقعة': report['مدة الإصلاح المتوقعة']?.trim() || ''
                    };
                }));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'تقرير البلاغات');
                const fileName = `تقرير_البلاغات_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showToast('✅ تم تصدير التقرير بنجاح', 'success');
            } catch (error) {
                console.error('خطأ في تصدير التقرير:', error);
                showToast('❌ فشل في تصدير التقرير', 'error');
            }
        }
        // ===== الأدوات المساعدة =====
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            if (!t) return;
            let icon = '';
            switch(type) {
                case 'success': icon = '<i class="fas fa-check-circle"></i>'; break;
                case 'error': icon = '<i class="fas fa-times-circle"></i>'; break;
                case 'warning': icon = '<i class="fas fa-exclamation-circle"></i>'; break;
                case 'info': icon = '<i class="fas fa-info-circle"></i>'; break;
            }
            t.innerHTML = `${icon} <span>${msg}</span>`;
            t.className = `toast show ${type}`;
            setTimeout(() => {
                t.className = 'toast';
            }, 4000);
        }
        // ===== تهيئة الأحداث =====
        document.addEventListener('DOMContentLoaded', function() {
            loadLocalSlaSettings();
            loadAutoCloseSettings();
            document.getElementById('refreshBtn').addEventListener('click', () => loadReports());
            document.getElementById('exportBtn').addEventListener('click', exportToExcel);
            document.getElementById('viewReportBtn').addEventListener('click', viewReport);
            document.getElementById('searchInput').addEventListener('input', renderReports);
            document.getElementById('statusFilter').addEventListener('change', renderReports);
            document.getElementById('priorityFilter').addEventListener('change', renderReports);
            document.getElementById('slaSettingsBtn').addEventListener('click', openSlaSettings);
            document.getElementById('saveSlaSettings').addEventListener('click', saveLocalSlaSettings);
            document.getElementById('autoCloseSettingsBtn').addEventListener('click', openAutoCloseSettings);
            document.getElementById('saveAutoCloseSettings').addEventListener('click', saveAutoCloseSettings);
            document.getElementById('exportBusHistoryBtn').addEventListener('click', exportBusHistory);
            document.getElementById('passwordSubmitBtn').addEventListener('click', verifyPassword);
            document.getElementById('exportReportBtn').addEventListener('click', exportReport);
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyPassword();
                }
            });
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => {
                        if (modal.style.display === 'flex') {
                            closeModal(modal.id);
                        }
                    });
                }
            });
            document.addEventListener('click', function(e) {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });
            setInterval(() => loadReports(true), CONFIG.REFRESH_INTERVAL);
            loadReports();
        });
    </script>
</body>
</html>
